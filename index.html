<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>PouchDB in Service Worker</title>
  </head>
  <body>
    <h1>PouchDB in Service Worker</h1>

    <script src="bower_components/pouchdb/dist/pouchdb.js"></script>
    <script>
      PouchDB.debug.enable('*');

      const localMainDB = new PouchDB('localMainDB');
      // const remoteDB = new PouchDB('http://couchadmin:test@localhost:5984/main');
      const remoteDB = new PouchDB('http://localhost:5984/main', {
        auth: {
          username: 'couchadmin',
          password: 'test'
        }
      });

      function push() {
        navigator.serviceWorker.ready
          .then(function(reg) {
            return reg.sync.register('push');
          });
      }

      function pull() {
        navigator.serviceWorker.ready
          .then(function(reg) {
            return reg.sync.register('pull');
          });
      }

      function watchLocalDB() {
        return localMainDB.changes({
          since: 'now',
          live: true
        }).on('change', function(change) {
          console.log('local change: ', change);
          push();
        }).on('error', function(err) {
          console.log('local err: ', err);
        });
      }

      function watchRemoteDB() {
        return remoteDB.changes({
          since: 'now',
          live: true
        }).on('change', function(change) {
          console.log('remote change: ', change);
          pull();
        }).on('error', function(err) {
          console.log('remote err: ', err);
        });
      }

      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js')
          .then(function(reg) {
            console.log('Yey!', reg);
            watchLocalDB();
            watchRemoteDB();
          }).catch(function(err) {
            console.log('Boo!', err);
          });
        }
    </script>
  </body>
</html>
