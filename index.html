<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>PouchDB in Service Worker</title>
  </head>
  <body>
    <h1>PouchDB in Service Worker</h1>

    <script src="bower_components/pouchdb/dist/pouchdb.js"></script>
    <script>
      // PouchDB.debug.enable('*');

      const localMainDB = new PouchDB('localMainDB');
      const remoteDB = new PouchDB('http://couchadmin:test@localhost:5984/main');

      function sync() {
        return localMainDB.sync(remoteDB).on('error', function(err) {
          console.log('local sync error:', err);
        });
      }

      function watchLocalDB() {
        return localMainDB.changes({
          since: 'now',
          live: true
        }).on('change', function(change) {
          console.log('local change: ', change);
          sync();
        }).on('error', function(err) {
          console.log('local err: ', err);
        });
      }

      function watchRemoteDB() {
        return remoteDB.changes({
          since: 'now',
          live: true
        }).on('change', function(change) {
          console.log('remote change: ', change);
          sync();
        }).on('error', function(err) {
          console.log('remote err: ', err);
        });
      }

      sync().then(function() {
        watchLocalDB();
        watchRemoteDB();
      });
    </script>
  </body>
</html>
